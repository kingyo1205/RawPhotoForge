name: release

on:
  release:
    types: [created]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            os_name: Ubuntu
            arch: x86_64
            lib_ext: so
            godot_os: linux
            addon_dir: Linux-x86_64
            export_name: "Linux/X11"
            exe_name: RawPhotoForge

          - os: windows-latest
            os_name: Windows
            arch: x86_64
            lib_ext: dll
            godot_os: windows
            addon_dir: Windows-x86_64
            export_name: "Windows Desktop"
            exe_name: RawPhotoForge.exe

          - os: macos-latest
            os_name: macOS
            arch: arm64
            lib_ext: dylib
            godot_os: macos
            addon_dir: macOS
            export_name: "macOS"
            exe_name: RawPhotoForge

    runs-on: ${{ matrix.os }}

    steps:
      # ----------------------------
      # checkout
      # ----------------------------
      - uses: actions/checkout@v4

      # ----------------------------
      # Rust
      # ----------------------------
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-about
        run: cargo install cargo-about

      - name: Build Rust GDExtension
        working-directory: rust/photo-editor-godot
        run: cargo build --release

      - name: Generate Rust licenses
        working-directory: rust/photo-editor-godot
        run: |
          cargo about init || true
          cargo about generate about.hbs > rust_licenses.html

      # ----------------------------
      # Copy GDExtension to Godot
      # ----------------------------
      - name: Copy GDExtension
        run: |
          cp rust/photo-editor-godot/target/release/libphoto_editor_godot.${{ matrix.lib_ext }} \
             rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}/libphoto_editor_godot.${{ matrix.lib_ext }}

      # ----------------------------
      # Godot
      # ----------------------------
      - name: Download Godot
        run: |
          mkdir godot-bin
          curl -L https://downloads.tuxfamily.org/godotengine/4.2/Godot_v4.2-stable_${{ matrix.godot_os }}.zip -o godot.zip
          unzip godot.zip -d godot-bin
          chmod +x godot-bin/*

      - name: Export Godot project
        working-directory: rust/raw-photo-forge
        run: |
          ../godot-bin/godot --headless \
            --export-release "${{ matrix.export_name }}" \
            ../../build/${{ matrix.exe_name }}

      # ----------------------------
      # Package
      # ----------------------------
      - name: Package
        run: |
          mkdir -p package/RawPhotoForge

          cp build/${{ matrix.exe_name }} package/RawPhotoForge/
          cp build/${{ matrix.exe_name }}.pck package/RawPhotoForge/ || true
          cp rust/photo-editor-godot/rust_licenses.html package/RawPhotoForge/

          cp -r rust/raw-photo-forge/addons package/RawPhotoForge/

          zip -r RawPhotoForge_${{ github.ref_name }}_${{ matrix.os_name }}_${{ matrix.arch }}.zip package

      # ----------------------------
      # Upload to Release
      # ----------------------------
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: RawPhotoForge_${{ github.ref_name }}_${{ matrix.os_name }}_${{ matrix.arch }}.zip
