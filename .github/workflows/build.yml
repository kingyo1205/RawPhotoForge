name: build-test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform_name: Linux
            bin_name: RawPhotoForge.x86_64
            lib_name: libphoto_editor_godot.so
            addon_dir: Linux-x86_64
          - os: windows-latest
            platform_name: Windows
            bin_name: RawPhotoForge.exe
            lib_name: photo_editor_godot.dll
            addon_dir: Windows-x86_64
          - os: macos-latest
            platform_name: macOS
            bin_name: RawPhotoForge.zip
            lib_name: libphoto_editor_godot.dylib
            addon_dir: macOS

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ----------------------------
      # Rust Setup & Build
      # ----------------------------
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Build Rust GDExtension
        run: cargo build --release -p photo-editor-godot

      # ----------------------------
      # GDExtension Library Placement
      # ----------------------------
      - name: Copy Library to Godot Project
        shell: bash
        run: |
          DEST="rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}"
          mkdir -p "$DEST"
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp target/release/${{ matrix.lib_name }} "$DEST/libphoto_editor_godot.dll"
          else
            cp target/release/${{ matrix.lib_name }} "$DEST/libphoto_editor_godot.${{ matrix.os == 'ubuntu-latest' && 'so' || 'dylib' }}"
          fi

      # ----------------------------
      # Godot Engine & Templates Setup
      # ----------------------------
      - name: Cache Godot Engine
        id: cache-godot
        uses: actions/cache@v4
        with:
          path: godot-bin
          key: ${{ runner.os }}-godot-4.5.1

      - name: Download Godot
        if: steps.cache-godot.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir godot-bin
          GODOT_VER="4.5.1-stable"
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            URL="https://github.com/godotengine/godot/releases/download/${GODOT_VER}/Godot_v${GODOT_VER}_linux.x86_64.zip"
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            URL="https://github.com/godotengine/godot/releases/download/${GODOT_VER}/Godot_v${GODOT_VER}_win64.exe.zip"
          else
            URL="https://github.com/godotengine/godot/releases/download/${GODOT_VER}/Godot_v${GODOT_VER}_macos.universal.zip"
          fi
          curl -L "$URL" -o godot.zip
          unzip godot.zip -d godot-bin
          rm godot.zip

      - name: Setup Godot Binary Path
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "GODOT_BIN=$(find godot-bin -name "Godot_v*" -type f)" >> $GITHUB_ENV
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "GODOT_BIN=$(find godot-bin -name "*_console.exe" -type f)" >> $GITHUB_ENV
          else
            echo "GODOT_BIN=$(find godot-bin -path "*/Contents/MacOS/Godot" -type f)" >> $GITHUB_ENV
          fi

      - name: Install Export Templates
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            TEMPLATE_DIR="$APPDATA/Godot/export_templates/4.5.1.stable"
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            TEMPLATE_DIR="$HOME/Library/Application Support/Godot/export_templates/4.5.1.stable"
          else
            TEMPLATE_DIR="$HOME/.local/share/godot/export_templates/4.5.1.stable"
          fi
          mkdir -p "$TEMPLATE_DIR"
          curl -L https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz -o templates.tpz
          unzip templates.tpz -d "$TEMPLATE_DIR"
          mv "$TEMPLATE_DIR/templates/"* "$TEMPLATE_DIR/"
          rm -rf "$TEMPLATE_DIR/templates"

      # ----------------------------
      # Export Test
      # ----------------------------
      - name: Godot Export Build Test
        shell: bash
        run: |
          chmod +x ${{ env.GODOT_BIN }}
          cd rust/raw-photo-forge
          mkdir -p build/${{ matrix.platform_name }}
          "${{ env.GODOT_BIN }}" --headless --editor --quit || true
          "${{ env.GODOT_BIN }}" --headless --export-release "${{ matrix.platform_name }}"

      - name: Verify Build Output
        shell: bash
        run: |
          # プリセットで指定したパスにファイルが存在するか確認
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
             ls -R rust/raw-photo-forge/build/macos/
          else
             test -f rust/raw-photo-forge/build/${{ matrix.platform_name == 'Linux' && 'linux' || 'windows' }}/${{ matrix.bin_name }}
          fi