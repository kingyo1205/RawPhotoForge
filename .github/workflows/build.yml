name: build-test

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            os_name: Ubuntu
            arch: x86_64
            lib_prefix: lib
            lib_ext: so
            addon_dir: Linux-x86_64
            export_name: Linux
            exe_name: RawPhotoForge.x86_64
            godot_asset: Godot_v4.5.1-stable_linux.x86_64.zip
            godot_template_dir: ~/.local/share/godot/export_templates/4.5.1.stable

          - os: windows-latest
            os_name: Windows
            arch: x86_64
            lib_prefix: ""
            lib_ext: dll
            addon_dir: Windows-x86_64
            export_name: Windows Desktop
            exe_name: RawPhotoForge.exe
            godot_asset: Godot_v4.5.1-stable_win64.exe.zip
            godot_template_dir: ~/AppData/Roaming/Godot/export_templates/4.5.1.stable

          - os: macos-latest
            os_name: macOS
            arch: arm64
            lib_prefix: lib
            lib_ext: dylib
            addon_dir: macOS
            export_name: macOS
            exe_name: RawPhotoForge.app
            godot_asset: Godot_v4.5.1-stable_macos.universal.zip
            godot_template_dir: ~/Library/Application Support/Godot/export_templates/4.5.1.stable

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Rust setup and build
      # ----------------------------
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build Rust GDExtension
        run: cargo build --release -p photo-editor-godot

      # ----------------------------
      # Copy GDExtension library
      # ----------------------------
      - name: Create addon libs directory
        shell: bash
        run: |
          mkdir -p rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}

      - name: Copy GDExtension library
        shell: bash
        run: |
          cp target/release/${{ matrix.lib_prefix }}photo_editor_godot.${{ matrix.lib_ext }} \
             rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}/libphoto_editor_godot.${{ matrix.lib_ext }}

      - name: Verify library exists
        shell: bash
        run: |
          if [ ! -f "rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}/libphoto_editor_godot.${{ matrix.lib_ext }}" ]; then
            echo "Error: Library not found"
            exit 1
          fi

      # ----------------------------
      # Download and setup Godot
      # ----------------------------
      - name: Download Godot
        shell: bash
        run: |
          mkdir -p godot-bin
          curl -L \
            https://github.com/godotengine/godot/releases/download/4.5.1-stable/${{ matrix.godot_asset }} \
            -o godot.zip

      - name: Extract Godot
        shell: bash
        run: |
          unzip -q godot.zip -d godot-bin

      - name: Find and setup Godot executable (Ubuntu)
        if: matrix.os_name == 'Ubuntu'
        shell: bash
        run: |
          GODOT_PATH=$(find godot-bin -type f -name "Godot_v*" | head -n 1)
          if [ -z "$GODOT_PATH" ]; then
            echo "Error: Godot executable not found"
            exit 1
          fi
          chmod +x "$GODOT_PATH"
          mv "$GODOT_PATH" godot-bin/godot
          echo "GODOT_BIN=./godot-bin/godot" >> $GITHUB_ENV

      - name: Find and setup Godot executable (Windows)
        if: matrix.os_name == 'Windows'
        shell: bash
        run: |
          GODOT_PATH=$(find godot-bin -type f -name "*_console.exe" | head -n 1)
          if [ -z "$GODOT_PATH" ]; then
            echo "Error: Godot executable not found"
            exit 1
          fi
          mv "$GODOT_PATH" godot-bin/godot.exe
          echo "GODOT_BIN=./godot-bin/godot.exe" >> $GITHUB_ENV

      - name: Find and setup Godot executable (macOS)
        if: matrix.os_name == 'macOS'
        shell: bash
        run: |
          GODOT_PATH=$(find godot-bin -type f -path "*/Contents/MacOS/Godot" | head -n 1)
          if [ -z "$GODOT_PATH" ]; then
            echo "Error: Godot executable not found"
            exit 1
          fi
          chmod +x "$GODOT_PATH"
          ln -s "$GODOT_PATH" godot-bin/godot
          echo "GODOT_BIN=./godot-bin/godot" >> $GITHUB_ENV

      # ----------------------------
      # Install Godot export templates
      # ----------------------------
      - name: Download export templates
        shell: bash
        run: |
          curl -L \
            https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz \
            -o templates.tpz

      - name: Install export templates (Unix)
        if: matrix.os_name != 'Windows'
        shell: bash
        run: |
          TEMPLATE_DIR="${{ matrix.godot_template_dir }}"
          mkdir -p "$TEMPLATE_DIR"
          unzip -q templates.tpz -d template_tmp
          mv template_tmp/templates/* "$TEMPLATE_DIR/"
          rm -rf template_tmp

      - name: Install export templates (Windows)
        if: matrix.os_name == 'Windows'
        shell: bash
        run: |
          TEMPLATE_DIR="${{ matrix.godot_template_dir }}"
          mkdir -p "$TEMPLATE_DIR"
          unzip -q templates.tpz -d template_tmp
          cp -r template_tmp/templates/* "$TEMPLATE_DIR/"
          rm -rf template_tmp

      # ----------------------------
      # Godot project validation
      # ----------------------------
      - name: Import Godot project
        shell: bash
        run: |
          cd rust/raw-photo-forge
          ${{ env.GODOT_BIN }} --headless --editor --quit --verbose || true

      - name: Wait for import completion
        shell: bash
        run: sleep 5

      # ----------------------------
      # Export test
      # ----------------------------
      - name: Create build directory
        shell: bash
        run: |
          mkdir -p rust/raw-photo-forge/build

      - name: Test Godot export
        shell: bash
        run: |
          cd rust/raw-photo-forge
          ${{ env.GODOT_BIN }} --headless \
            --export-release "${{ matrix.export_name }}" \
            build/${{ matrix.exe_name }} \
            --verbose

      # ----------------------------
      # Verify export result
      # ----------------------------
      - name: Check export result (Unix)
        if: matrix.os_name != 'macOS'
        shell: bash
        run: |
          if [ ! -f "rust/raw-photo-forge/build/${{ matrix.exe_name }}" ]; then
            echo "Error: Export failed - executable not found"
            exit 1
          fi
          echo "Export successful: ${{ matrix.exe_name }}"

      - name: Check export result (macOS)
        if: matrix.os_name == 'macOS'
        shell: bash
        run: |
          if [ ! -d "rust/raw-photo-forge/build/${{ matrix.exe_name }}" ]; then
            echo "Error: Export failed - .app bundle not found"
            exit 1
          fi
          if [ ! -f "rust/raw-photo-forge/build/${{ matrix.exe_name }}/Contents/MacOS/RawPhotoForge" ]; then
            echo "Error: Export failed - executable not found in .app bundle"
            exit 1
          fi
          echo "Export successful: ${{ matrix.exe_name }}"

      # ----------------------------
      # Debug information on failure
      # ----------------------------
      - name: Debug - Show directory structure
        if: failure()
        shell: bash
        run: |
          echo "=== Addon directory structure ==="
          ls -lR rust/raw-photo-forge/addons/ || true
          echo ""
          echo "=== Build directory structure ==="
          ls -lR rust/raw-photo-forge/build/ || true
          echo ""
          echo "=== Target directory structure ==="
          ls -lR target/release/ || true

      - name: Debug - Show Godot logs
        if: failure()
        shell: bash
        run: |
          if [ -f "$HOME/.local/share/godot/app_userdata/RawPhotoForge/logs/godot.log" ]; then
            echo "=== Godot log (Linux) ==="
            cat "$HOME/.local/share/godot/app_userdata/RawPhotoForge/logs/godot.log"
          fi
          if [ -f "$HOME/AppData/Roaming/Godot/app_userdata/RawPhotoForge/logs/godot.log" ]; then
            echo "=== Godot log (Windows) ==="
            cat "$HOME/AppData/Roaming/Godot/app_userdata/RawPhotoForge/logs/godot.log"
          fi
          if [ -f "$HOME/Library/Application Support/Godot/app_userdata/RawPhotoForge/logs/godot.log" ]; then
            echo "=== Godot log (macOS) ==="
            cat "$HOME/Library/Application Support/Godot/app_userdata/RawPhotoForge/logs/godot.log"
          fi