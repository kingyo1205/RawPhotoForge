name: build-test

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            os_name: Ubuntu
            arch: x86_64
            lib_prefix: lib
            lib_ext: so
            addon_dir: Linux-x86_64
            export_name: Linux
            exe_name: RawPhotoForge
            godot_asset: Godot_v4.5.1-stable_linux.x86_64.zip
            export_path: "../../RawPhotoForge_v1.0.0-alpha_Linux_x86_64/RawPhotoForge.x86_64"

          - os: windows-latest
            os_name: Windows
            arch: x86_64
            lib_prefix: ""
            lib_ext: dll
            addon_dir: Windows-x86_64
            export_name: Windows
            exe_name: RawPhotoForge.exe
            godot_asset: Godot_v4.5.1-stable_win64.exe.zip
            export_path: "../../RawPhotoForge_v1.0.0-alpha_Windows_x86_64/RawPhotoForge.exe"

          - os: macos-latest
            os_name: macOS
            arch: arm64
            lib_prefix: lib
            lib_ext: dylib
            addon_dir: macOS
            export_name: macOS
            exe_name: RawPhotoForge
            godot_asset: Godot_v4.5.1-stable_macos.universal.zip
            export_path: "../../RawPhotoForge_v1.0.0-alpha_macOS_arm64/RawPhotoForge"

    steps:
      # ----------------------------
      # checkout
      # ----------------------------
      - uses: actions/checkout@v4

      # ----------------------------
      # Rust
      # ----------------------------
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-about
        run: cargo install cargo-about

      - name: Build Rust GDExtension
        run: cargo build --release -p photo-editor-godot

      - name: Generate Rust licenses
        run: |
          cargo about init || true
          cargo about generate about.hbs > rust/photo-editor-godot/rust_licenses.html

      # ----------------------------
      # Copy GDExtension
      # ----------------------------
      - name: Copy GDExtension
        run: |
          mkdir -p rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}
          cp target/release/${{ matrix.lib_prefix }}photo_editor_godot.${{ matrix.lib_ext }} \
             rust/raw-photo-forge/addons/photo_editor/libs/${{ matrix.addon_dir }}/libphoto_editor_godot.${{ matrix.lib_ext }}

      # ----------------------------
      # Generate minimal export preset
      # ----------------------------
      - name: Generate export_presets.cfg
        shell: bash
        run: |
          cat > rust/raw-photo-forge/export_presets.cfg << EOF
[preset.0]
name="${{ matrix.export_name }}"
platform="${{ matrix.export_name }}"
runnable=true
advanced_options=false
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="${{ matrix.export_path }}"
patches=PackedStringArray()
encryption_include_filters=""
encryption_exclude_filters=""
seed=0
encrypt_pck=false
encrypt_directory=false
script_export_mode=2

[preset.0.options]
custom_template/debug=""
custom_template/release=""
debug/export_console_wrapper=2
binary_format/embed_pck=false
texture_format/s3tc_bptc=true
texture_format/etc2_astc=false
shader_baker/enabled=false
binary_format/architecture="${{ matrix.arch }}"
ssh_remote_deploy/enabled=false
ssh_remote_deploy/host="user@host_ip"
ssh_remote_deploy/port="22"
ssh_remote_deploy/extra_args_ssh=""
ssh_remote_deploy/extra_args_scp=""
ssh_remote_deploy/run_script="#!/usr/bin/env bash
export DISPLAY=:0
unzip -o -q \"{temp_dir}/{archive_name}\" -d \"{temp_dir}\"
\"{temp_dir}/{exe_name}\" {cmd_args}"
ssh_remote_deploy/cleanup_script="#!/usr/bin/env bash
kill \$(pgrep -x -f \"{temp_dir}/{exe_name} {cmd_args}\")
rm -rf \"{temp_dir}\""
dotnet/include_scripts_content=false
dotnet/include_debug_symbols=false
dotnet/embed_build_outputs=false
EOF

      # ----------------------------
      # Godot download
      # ----------------------------
      - name: Download Godot
        shell: bash
        run: |
          mkdir godot-bin
          curl -L \
            https://github.com/godotengine/godot/releases/download/4.5.1-stable/${{ matrix.godot_asset }} \
            -o godot.zip
          unzip godot.zip -d godot-bin

          if [ "${{ matrix.os_name }}" = "Ubuntu" ]; then
            GODOT_PATH=$(find godot-bin -type f -name "Godot_v*" | head -n 1)
          elif [ "${{ matrix.os_name }}" = "Windows" ]; then
            GODOT_PATH=$(find godot-bin -type f -name "*_console.exe" | head -n 1)
          else
            GODOT_PATH=$(find godot-bin -type f -path "*/Contents/MacOS/*" | head -n 1)
          fi

          if [ -z "$GODOT_PATH" ]; then
            echo "Godot executable not found"
            exit 1
          fi

          chmod +x "$GODOT_PATH"
          mv "$GODOT_PATH" godot-bin/godot

      # ----------------------------
      # Godot export templates
      # ----------------------------
      - name: Install Godot export templates
        shell: bash
        run: |
          TEMPLATE_DIR="$HOME/.local/share/godot/export_templates/4.5.1.stable"
          mkdir -p "$TEMPLATE_DIR"
          curl -L \
            https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz \
            -o templates.tpz
          unzip templates.tpz -d "$TEMPLATE_DIR"

      # ----------------------------
      # Godot validation
      # ----------------------------
      - name: Godot editor validation
        shell: bash
        run: |
          cd rust/raw-photo-forge
          ../../godot-bin/godot --headless --editor --quit --verbose

      - name: Godot headless export test
        shell: bash
        run: |
          cd rust/raw-photo-forge
          mkdir -p build
          ../../godot-bin/godot --headless \
            --export-release "${{ matrix.export_name }}" \
            build/${{ matrix.exe_name }}

      # ----------------------------
      # Result check
      # ----------------------------
      - name: Check export result
        run: |
          test -f rust/raw-photo-forge/build/${{ matrix.exe_name }} || (echo "export failed" && exit 1)

      - name: Debug tree
        if: failure()
        run: |
          tree rust/raw-photo-forge/addons || true
          tree target/release || true
